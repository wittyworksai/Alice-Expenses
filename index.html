<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Alice Family Expense</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        * {
            box-sizing: border-box;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50">
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function AliceFamilyExpense() {
            const [expenses, setExpenses] = useState([]);
            const [amount, setAmount] = useState('');
            const [person, setPerson] = useState('');
            const [category, setCategory] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [familyMembers, setFamilyMembers] = useState(['Child 1', 'Child 2', 'Husband']);
            const [paymentMethods, setPaymentMethods] = useState(['Cash', 'Credit Card 1', 'Credit Card 2', 'Wire Transfer', 'Debit Card']);
            const [newMember, setNewMember] = useState('');
            const [newPayment, setNewPayment] = useState('');
            const [filter, setFilter] = useState('all');
            const [showReports, setShowReports] = useState(false);
            const [reportType, setReportType] = useState('person');
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');
            const [currency, setCurrency] = useState('AED');

            const currencySymbols = {
                'AED': 'AED',
                'EUR': 'â‚¬',
                'CAD': 'C$'
            };

            useEffect(() => {
                loadData();
            }, []);

            useEffect(() => {
                saveData();
            }, [expenses, familyMembers, paymentMethods, currency]);

            const loadData = () => {
                try {
                    const expensesData = localStorage.getItem('alice-family-expenses');
                    const membersData = localStorage.getItem('alice-family-members');
                    const paymentsData = localStorage.getItem('alice-payment-methods');
                    const currencyData = localStorage.getItem('alice-currency');
                    
                    if (expensesData) {
                        setExpenses(JSON.parse(expensesData));
                    }
                    if (membersData) {
                        setFamilyMembers(JSON.parse(membersData));
                    }
                    if (paymentsData) {
                        setPaymentMethods(JSON.parse(paymentsData));
                    }
                    if (currencyData) {
                        setCurrency(currencyData);
                    }
                } catch (error) {
                    console.log('No saved data found');
                }
            };

            const saveData = () => {
                try {
                    localStorage.setItem('alice-family-expenses', JSON.stringify(expenses));
                    localStorage.setItem('alice-family-members', JSON.stringify(familyMembers));
                    localStorage.setItem('alice-payment-methods', JSON.stringify(paymentMethods));
                    localStorage.setItem('alice-currency', currency);
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            };

            const addExpense = () => {
                if (amount && person && category && paymentMethod) {
                    const newExpense = {
                        id: Date.now(),
                        amount: parseFloat(amount),
                        person,
                        category,
                        paymentMethod,
                        date
                    };
                    setExpenses([newExpense, ...expenses]);
                    setAmount('');
                    setCategory('');
                }
            };

            const deleteExpense = (id) => {
                setExpenses(expenses.filter(e => e.id !== id));
            };

            const addFamilyMember = () => {
                if (newMember && !familyMembers.includes(newMember)) {
                    setFamilyMembers([...familyMembers, newMember]);
                    setNewMember('');
                }
            };

            const removeFamilyMember = (member) => {
                setFamilyMembers(familyMembers.filter(m => m !== member));
            };

            const addPaymentMethod = () => {
                if (newPayment && !paymentMethods.includes(newPayment)) {
                    setPaymentMethods([...paymentMethods, newPayment]);
                    setNewPayment('');
                }
            };

            const removePaymentMethod = (method) => {
                setPaymentMethods(paymentMethods.filter(m => m !== method));
            };

            const filteredExpenses = filter === 'all' 
                ? expenses 
                : expenses.filter(e => e.person === filter);

            const getTotalByPerson = (person) => {
                return expenses
                    .filter(e => e.person === person)
                    .reduce((sum, e) => sum + e.amount, 0);
            };

            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

            const getReportData = () => {
                let filtered = expenses;
                
                if (dateFrom) {
                    filtered = filtered.filter(e => e.date >= dateFrom);
                }
                if (dateTo) {
                    filtered = filtered.filter(e => e.date <= dateTo);
                }

                const grouped = {};

                if (reportType === 'person') {
                    filtered.forEach(expense => {
                        if (!grouped[expense.person]) {
                            grouped[expense.person] = { total: 0, count: 0, expenses: [] };
                        }
                        grouped[expense.person].total += expense.amount;
                        grouped[expense.person].count += 1;
                        grouped[expense.person].expenses.push(expense);
                    });
                } else if (reportType === 'payment') {
                    filtered.forEach(expense => {
                        if (!grouped[expense.paymentMethod]) {
                            grouped[expense.paymentMethod] = { total: 0, count: 0, expenses: [] };
                        }
                        grouped[expense.paymentMethod].total += expense.amount;
                        grouped[expense.paymentMethod].count += 1;
                        grouped[expense.paymentMethod].expenses.push(expense);
                    });
                } else if (reportType === 'date') {
                    filtered.forEach(expense => {
                        if (!grouped[expense.date]) {
                            grouped[expense.date] = { total: 0, count: 0, expenses: [] };
                        }
                        grouped[expense.date].total += expense.amount;
                        grouped[expense.date].count += 1;
                        grouped[expense.date].expenses.push(expense);
                    });
                }

                return grouped;
            };

            const shareReport = () => {
                const reportData = getReportData();
                const reportTypeLabel = reportType === 'person' ? 'By Person' : reportType === 'payment' ? 'By Payment Method' : 'By Date';
                const dateRange = (dateFrom || dateTo) ? `(${dateFrom || 'start'} to ${dateTo || 'today'})` : '(All time)';
                
                let reportText = `ALICE FAMILY EXPENSE REPORT\n`;
                reportText += `Report Type: ${reportTypeLabel} ${dateRange}\n`;
                reportText += `Currency: ${currency}\n`;
                reportText += `Generated: ${new Date().toLocaleDateString()}\n`;
                reportText += `\n${'='.repeat(50)}\n\n`;

                const sortedData = Object.entries(reportData).sort(([, a], [, b]) => b.total - a.total);
                
                sortedData.forEach(([key, data]) => {
                    reportText += `${key.toUpperCase()}\n`;
                    reportText += `Total: ${currencySymbols[currency]} ${data.total.toFixed(2)} (${data.count} transaction${data.count !== 1 ? 's' : ''})\n`;
                    reportText += `${'-'.repeat(50)}\n`;
                    
                    data.expenses.forEach(expense => {
                        reportText += `  ${expense.date} - ${expense.category} - ${currencySymbols[currency]} ${expense.amount.toFixed(2)}\n`;
                        if (reportType !== 'person') reportText += `    Person: ${expense.person}\n`;
                        if (reportType !== 'payment') reportText += `    Payment: ${expense.paymentMethod}\n`;
                    });
                    reportText += `\n`;
                });

                const grandTotal = sortedData.reduce((sum, [, data]) => sum + data.total, 0);
                reportText += `${'='.repeat(50)}\n`;
                reportText += `GRAND TOTAL: ${currencySymbols[currency]} ${grandTotal.toFixed(2)}\n`;

                navigator.clipboard.writeText(reportText).then(() => {
                    alert('Report copied to clipboard! You can now paste it into WhatsApp, email, or any messaging app.');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = reportText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Report copied to clipboard! You can now paste it into WhatsApp, email, or any messaging app.');
                });
            };

            return (
                <div className="p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
